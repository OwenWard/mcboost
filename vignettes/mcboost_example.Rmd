---
title: "MCBoost - Health Survey Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MCBoost - Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tidyverse)
library(purrr)
library(PracTools)
library(randomForest)
library(mlr3)
library(mlr3learners)
library(mcboost)
```

## Data

```{r}
data(nhis.large)
```

```{r}
predictors <- c("sex", "age.grp", "hisp", "parents", "educ", "race", "inc.grp", "doing.lw", "limited")

nhis <- nhis.large %>%
  mutate_at(predictors, as_factor) %>%
  mutate_at(predictors, fct_explicit_na) %>%
  drop_na(notcov) %>%
  select(all_of(predictors), notcov)

nhis$notcov <- factor(ifelse(nhis$notcov == 1, "notcov", "cov"))

nhis_enc <- data.frame(model.matrix(notcov ~ . -sex -hisp -race, data = nhis)[,-1])
nhis_enc$notcov <- nhis$notcov
nhis_enc_f <- data.frame(model.matrix(notcov ~ ., data = nhis)[,-1])
nhis_enc_f$notcov <- nhis$notcov
```

```{r}
splits <- sample(1:3, size = nrow(nhis_enc), 
                 replace = TRUE,
                 prob = c(0.6, 0.2, 0.2))

train <- nhis_enc[splits == 1, ]
post <- nhis_enc[splits == 2, ]
test <- nhis_enc_f[splits == 3, ]
```

## Initial model

```{r}
set.seed(23)
rf <- randomForest(notcov ~ ., 
                   data = train)
```

## MCBoost

```{r}
init_predictor = function(data) {
  predict(rf, data, type = "prob")[, 2]
}
```

```{r}
d <- select(post, -notcov)
l <- 1 - one_hot(post$notcov)
```

```{r}
ridge = LearnerResidualFitter$new(lrn("regr.glmnet", alpha = 0, lambda = 2 / nrow(post)))
```

```{r}
mc = MCBoost$new(init_predictor = init_predictor, 
                 subpop_fitter = ridge,
                 multiplicative = TRUE,
                 partition = TRUE,
                 max_iter = 15)
mc$multicalibrate(d, l)
```

## Evaluate

```{r}
test$naive <- predict(rf, newdata = test, type = "prob")[, 2]
test$mcb <- mc$predict_probs(test)
```

```{r}
test$c_naive <- round(test$naive)
test$c_mcb <- round(test$mcb)
test$label <- 1 - one_hot(test$notcov)

mean(test$c_naive == test$label)
mean(test$c_mcb == test$label)
```

```{r}
eval <- test %>%
  group_by(sex2, age.grp2, age.grp3, age.grp4, age.grp5, hisp2, hisp3, hisp4, educ2, educ3, educ4, race2, race3) %>%
  summarise(accuracy_rf = mean(c_naive == label), 
            accuracy_mcb = mean(c_mcb == label),
            bias_rf = (mean(naive) - mean(label))*100,
            bias_mcb = (mean(mcb) - mean(label))*100,
            size = n())
```

```{r}
grouping_vars <- c("sex2", "hisp2", "hisp3", "hisp4", "race2", "race3")

map(grouping_vars, group_by_at, .tbl = test) %>%
  map(summarise,
      'accuracy_rf' = mean(c_naive == label),
      'accuracy_mcb' = mean(c_mcb == label),
      'bias_rf' = (mean(naive) - mean(label))*100,
      'bias_mcb' = (mean(mcb) - mean(label))*100,
      'size' = n()) %>%
  bind_rows()
```


```{r}
eval_long <- eval %>%
 pivot_longer(
   cols = accuracy_rf:bias_mcb,
   names_to = c("type", "model"),
   names_sep = "_") %>%
  arrange(desc(size))

eval_long$id <- rep(1:(nrow(eval_long)/4), each = 4)
```

```{r}
eval_long %>%
  filter(type == "bias" & size >= 25) %>%
  ggplot() +
  geom_line(aes(id, value, color = model))

eval_long %>%
  filter(type == "bias" & size >= 50) %>%
  ggplot(aes(id, model)) +
  geom_raster(aes(fill = abs(value)))
```

